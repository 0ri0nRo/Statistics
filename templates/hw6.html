<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empirical vs Theoretical Distribution with User-Defined Parameters</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Empirical vs Theoretical Distribution with Recursive Statistics</h1>

<!-- Form for user input -->
<div>
    <label for="values">Values (comma-separated):</label>
    <input type="text" id="values" value="1,2,3,4">
</div>
<div>
    <label for="probabilities">Probabilities (comma-separated, must sum to 1):</label>
    <input type="text" id="probabilities" value="0.1,0.2,0.3,0.4">
</div>
<div>
    <label for="numSamples">Number of Samples:</label>
    <input type="number" id="numSamples" value="1000">
</div>
<button onclick="startSimulation()">Start Simulation</button>

<canvas id="distributionChart" width="800" height="400"></canvas>
<canvas id="statsChart" width="800" height="400"></canvas>

<script>
// Initialize variables for storing parameters and simulation data
let values, probabilities, numSamples;
let sampleSize, empiricalMean, m2, empiricalData, theoreticalData, meanData, varianceData;
let distributionChart, statsChart;

// Function to parse and set user input
function setUserInput() {
    values = document.getElementById("values").value.split(',').map(Number);
    probabilities = document.getElementById("probabilities").value.split(',').map(Number);
    numSamples = parseInt(document.getElementById("numSamples").value);

    // Check if probabilities sum to 1
    const sumProbabilities = probabilities.reduce((a, b) => a + b, 0);
    if (Math.abs(sumProbabilities - 1) > 0.01) {
        alert("Probabilities must sum to 1.");
        return false;
    }
    return true;
}

// Function to reset all simulation variables
function resetSimulation() {
    sampleSize = 0;
    empiricalMean = 0;
    m2 = 0;
    empiricalData = [];
    theoreticalData = [];
    meanData = [];
    varianceData = [];
}

// Function to calculate theoretical mean and variance
function theoreticalStats(values, probabilities) {
    let mean = 0;
    let variance = 0;
    for (let i = 0; i < values.length; i++) {
        mean += values[i] * probabilities[i];
    }
    for (let i = 0; i < values.length; i++) {
        variance += probabilities[i] * (values[i] - mean) ** 2;
    }
    return { mean, variance };
}

// Function to generate a sample from the discrete distribution
function generateSample() {
    let rnd = Math.random();
    let cumulative = 0;
    for (let i = 0; i < probabilities.length; i++) {
        cumulative += probabilities[i];
        if (rnd < cumulative) return values[i];
    }
    return values[values.length - 1];
}

// Function to update mean and variance recursively using Welford's algorithm
function updateStats(newSample, n, mean, m2) {
    const delta = newSample - mean;
    mean += delta / n;
    m2 += delta * (newSample - mean);
    const variance = n > 1 ? m2 / (n - 1) : 0;
    return { mean, m2, variance };
}

// Initialize charts
function initializeCharts() {
    const ctx1 = document.getElementById('distributionChart').getContext('2d');
    distributionChart = new Chart(ctx1, {
        type: 'line',
        data: {
            datasets: [
                { label: 'Empirical CDF', data: empiricalData, borderColor: 'blue', fill: false, stepped: true },
                { label: 'Theoretical CDF', data: theoreticalData, borderColor: 'red', fill: false, borderDash: [5, 5], stepped: true }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { type: 'linear', title: { display: true, text: 'Value' } },
                y: { type: 'linear', title: { display: true, text: 'Cumulative Probability' } },
            }
        }
    });

    const ctx2 = document.getElementById('statsChart').getContext('2d');
    statsChart = new Chart(ctx2, {
        type: 'line',
        data: {
            datasets: [
                { label: 'Empirical Mean', data: meanData, borderColor: 'blue', fill: false },
                { label: 'Empirical Variance', data: varianceData, borderColor: 'green', fill: false },
                { label: 'Theoretical Mean', data: Array(numSamples).fill({ y: theoreticalStats(values, probabilities).mean }), borderColor: 'blue', borderDash: [5, 5], fill: false },
                { label: 'Theoretical Variance', data: Array(numSamples).fill({ y: theoreticalStats(values, probabilities).variance }), borderColor: 'green', borderDash: [5, 5], fill: false }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { type: 'linear', title: { display: true, text: 'Sample Size' } },
                y: { type: 'linear', title: { display: true, text: 'Value' } },
            }
        }
    });
}

// Function to update charts
function updateCharts() {
    distributionChart.update();
    statsChart.update();
}

// Main function to run the simulation
function runSimulation(numSamples) {
    for (let i = 1; i <= numSamples; i++) {
        const sample = generateSample();
        sampleSize++;

        // Update empirical mean and variance
        const stats = updateStats(sample, sampleSize, empiricalMean, m2);
        empiricalMean = stats.mean;
        m2 = stats.m2;

        meanData.push({ x: sampleSize, y: empiricalMean });
        varianceData.push({ x: sampleSize, y: stats.variance });

        // Update empirical CDF
        let cumulativeCount = Array(values.length).fill(0);
        for (let j = 0; j < sampleSize; j++) {
            cumulativeCount[values.indexOf(generateSample())]++;
        }
        empiricalData.length = 0;
        let cumulative = 0;
        for (let j = 0; j < values.length; j++) {
            cumulative += cumulativeCount[j] / sampleSize;
            empiricalData.push({ x: values[j], y: cumulative });
        }

        // Update charts every 50 samples for performance
        if (i % 50 === 0) updateCharts();
    }
    updateCharts();  // Final update after loop completes
}

// Function to start the simulation based on user input
function startSimulation() {
    if (!setUserInput()) return;
    resetSimulation();
    initializeCharts();

    // Calculate theoretical CDF
    let cumulative = 0;
    theoreticalData.length = 0;
    for (let i = 0; i < probabilities.length; i++) {
        cumulative += probabilities[i];
        theoreticalData.push({ x: values[i], y: cumulative });
    }

    // Run simulation with user-defined sample size
    runSimulation(numSamples);
}
</script>
</body>
</html>
